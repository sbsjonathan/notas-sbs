// save/sync-bridge.js - Sistema que conecta todas as p√°ginas

class SyncBridge {
    constructor() {
        this.currentSemana = null;
        this.isLoggedIn = false;
        this.hasLoadedFromSupabase = false; // NOVO: Flag para controlar carregamento
        
        console.log('üåâ SyncBridge iniciando - conectando todas as p√°ginas...');
        this.init();
    }

    init() {
        this.detectSemana();
        this.checkLoginStatus();
        this.checkIfAlreadyLoaded(); // NOVO: Verifica se j√° carregou
        this.setupStorageListener();
        this.setupPeriodicCheck();
        
        // Se for p√°gina do editor, aguarda editor estar pronto
        if (window.location.pathname.includes('richtext') || window.location.pathname.includes('container')) {
            this.waitForEditor();
        }
        
        console.log('‚úÖ SyncBridge ativo:', {
            semana: this.currentSemana,
            logado: this.isLoggedIn,
            jaCarregou: this.hasLoadedFromSupabase,
            pagina: this.detectPage()
        });
    }

    detectPage() {
        const path = window.location.pathname;
        if (path.includes('richtext') || path.includes('container')) return 'editor';
        if (path.includes('auth') || path.includes('save')) return 'login';
        return 'other';
    }

    detectSemana() {
        this.currentSemana = window.semanaAtual || 
                            new URLSearchParams(window.location.search).get('semana') ||
                            this.getFallbackWeek();
    }

    getFallbackWeek() {
        const agora = new Date();
        const dia = String(agora.getDate()).padStart(2, '0');
        const mes = String(agora.getMonth() + 1).padStart(2, '0');
        return `${dia}-${mes}`;
    }

    checkLoginStatus() {
        const savedUser = localStorage.getItem('supabase_user');
        this.isLoggedIn = !!savedUser;
    }

    /**
     * NOVO: Verifica se j√° carregou do Supabase para esta semana
     */
    checkIfAlreadyLoaded() {
        const loadKey = `supabase_loaded_${this.currentSemana}`;
        const lastLoaded = localStorage.getItem(loadKey);
        
        console.log('üîç Verificando se j√° carregou:', {
            semana: this.currentSemana,
            chave: loadKey,
            valorSalvo: lastLoaded,
            logado: this.isLoggedIn
        });
        
        if (lastLoaded && this.isLoggedIn) {
            this.hasLoadedFromSupabase = true;
            console.log('‚úÖ J√Å CARREGOU do Supabase para esta semana - usar√° cache local');
        } else {
            this.hasLoadedFromSupabase = false;
            console.log('üì≠ AINDA N√ÉO CARREGOU do Supabase para esta semana - carregar√° do Supabase');
        }
        
        return this.hasLoadedFromSupabase;
    }

    /**
     * NOVO: Marca que j√° carregou do Supabase
     */
    markAsLoaded() {
        const loadKey = `supabase_loaded_${this.currentSemana}`;
        const timestamp = Date.now().toString();
        localStorage.setItem(loadKey, timestamp);
        this.hasLoadedFromSupabase = true;
        
        console.log('‚úÖ MARCADO COMO CARREGADO:', {
            semana: this.currentSemana,
            chave: loadKey,
            timestamp: timestamp,
            flag: this.hasLoadedFromSupabase
        });
    }

    /**
     * NOVO: For√ßa nova carga (limpa a marca)
     */
    clearLoadedFlag() {
        const loadKey = `supabase_loaded_${this.currentSemana}`;
        localStorage.removeItem(loadKey);
        this.hasLoadedFromSupabase = false;
        console.log('üóëÔ∏è Flag de carregamento limpa - pr√≥ximo load ser√° do Supabase');
    }

    /**
     * ESCUTA MUDAN√áAS EM OUTRAS ABAS/P√ÅGINAS
     */
    setupStorageListener() {
        // Escuta mudan√ßas no localStorage
        window.addEventListener('storage', (e) => {
            console.log('üîî Mudan√ßa detectada:', e.key);
            
            if (e.key === 'sync_signal_content_updated') {
                this.handleContentUpdated(e.newValue);
            }
            else if (e.key === 'sync_signal_load_content') {
                this.handleLoadRequest(e.newValue);
            }
            else if (e.key === 'supabase_user') {
                this.handleLoginStatusChanged(e.newValue);
            }
        });

        // Para mudan√ßas na mesma aba (n√£o funciona com storage event)
        this.setupCustomEvents();
    }

    /**
     * EVENTOS PERSONALIZADOS PARA MESMA ABA
     */
    setupCustomEvents() {
        document.addEventListener('syncbridge_content_updated', (e) => {
            console.log('üîî Conte√∫do atualizado (mesma aba)');
            this.applyContentToEditor(e.detail.content);
        });

        document.addEventListener('syncbridge_load_request', (e) => {
            console.log('üîî Solicita√ß√£o de carregamento (mesma aba)');
            this.executeLoad();
        });
    }

    /**
     * VERIFICA MUDAN√áAS PERIODICAMENTE - REMOVIDO O AUTO-LOAD
     */
    setupPeriodicCheck() {
        // Apenas monitora login status, SEM carregar automaticamente
        setInterval(() => {
            const newLoginStatus = !!localStorage.getItem('supabase_user');
            if (newLoginStatus !== this.isLoggedIn) {
                console.log('üîÑ Login status changed:', newLoginStatus);
                this.isLoggedIn = newLoginStatus;
                
                // REMOVIDO: N√£o carrega automaticamente quando detecta login
                // if (newLoginStatus) {
                //     setTimeout(() => {
                //         this.executeLoad();
                //     }, 1000);
                // }
            }
        }, 2000);
    }

    /**
     * AGUARDA EDITOR ESTAR PRONTO - SEM AUTO-LOAD
     */
    waitForEditor() {
        const checkEditor = () => {
            const editor = document.getElementById('text-editor');
            if (editor) {
                console.log('üìù Editor encontrado - SyncBridge conectado (sem auto-load)');
                // REMOVIDO: Auto-load quando encontra editor
                // setTimeout(() => {
                //     this.smartLoad('editor_open');
                // }, 500);
            } else {
                setTimeout(checkEditor, 200);
            }
        };
        checkEditor();
    }

    // === HANDLERS === //

    handleContentUpdated(newValueJson) {
        try {
            const data = JSON.parse(newValueJson);
            if (data.semana === this.currentSemana) {
                console.log('üì• Aplicando conte√∫do atualizado de outra p√°gina');
                this.applyContentToEditor(data.content);
            }
        } catch (e) {
            console.error('Erro ao processar conte√∫do atualizado:', e);
        }
    }

    handleLoadRequest(newValueJson) {
        console.log('üì• Solicita√ß√£o de carregamento de outra p√°gina');
        // Se for request for√ßado, for√ßa carregamento do Supabase
        try {
            const data = JSON.parse(newValueJson);
            if (data.forced) {
                this.clearLoadedFlag(); // Limpa flag para for√ßar Supabase
            }
        } catch (e) {}
        
        this.smartLoad('manual');
    }

    handleLoginStatusChanged(newValue) {
        const wasLoggedIn = this.isLoggedIn;
        this.isLoggedIn = !!newValue;
        
        console.log('üë§ Status login mudou:', wasLoggedIn, '‚Üí', this.isLoggedIn);
        
        // REMOVIDO: N√£o carrega automaticamente quando detecta mudan√ßa de login
        // if (!wasLoggedIn && this.isLoggedIn) {
        //     setTimeout(() => {
        //         this.executeLoad();
        //     }, 1000);
        // }
    }

    // === A√á√ïES === //

    /**
     * NOVO: Carregamento inteligente que decide de onde carregar
     */
    async smartLoad(trigger = 'manual') {
        if (!this.currentSemana) {
            console.log('‚ö†Ô∏è Semana n√£o detectada');
            return;
        }

        // Atualiza status antes de decidir
        this.checkLoginStatus();
        this.checkIfAlreadyLoaded();

        console.log(`üß† Smart Load (${trigger}):`, {
            logado: this.isLoggedIn,
            jaCarregou: this.hasLoadedFromSupabase,
            semana: this.currentSemana,
            trigger: trigger,
            internet: navigator.onLine
        });

        // L√ìGICA SIMPLIFICADA:
        // Se trigger for 'editor_open' E j√° carregou E est√° logado ‚Üí s√≥ cache local
        // Caso contr√°rio ‚Üí tenta Supabase se logado

        let useOnlyCache = (trigger === 'editor_open' && this.hasLoadedFromSupabase && this.isLoggedIn);

        console.log('üîç Decis√£o de carregamento:', {
            useOnlyCache: useOnlyCache,
            motivo: useOnlyCache ? 'J√° carregou do Supabase anteriormente' : 'Primeira vez ou carregamento manual'
        });

        // Se vai tentar Supabase E tem internet, mostra loading
        const willTrySupabase = !useOnlyCache && this.isLoggedIn && navigator.onLine;
        if (willTrySupabase) {
            this.showSupabaseLoading();
        }

        try {
            let content = null;
            let source = 'nenhum';

            // Se deve usar s√≥ cache, pula Supabase
            if (!useOnlyCache && this.isLoggedIn && window.SupabaseSync) {
                console.log('‚òÅÔ∏è Carregando do Supabase...');
                content = await window.SupabaseSync.carregarRichtextAnotacoes(this.currentSemana);
                if (content) {
                    source = 'supabase';
                    this.markAsLoaded(); // Marca como carregado
                    console.log('‚úÖ Carregado do Supabase (marcado como carregado)');
                }
            }

            // Fallback para cache local
            if (!content) {
                console.log('üíæ Carregando do cache local...');
                content = this.loadFromLocalCache();
                if (content) {
                    source = 'cache-local';
                    console.log('‚úÖ Carregado do cache local');
                }
            }

            // Aplica se encontrou conte√∫do
            if (content && content.trim()) {
                this.applyContentToEditor(content);
                this.showFeedback(`Carregado (${source})`, 'success');
                
                // Sinaliza para outras p√°ginas
                this.signalContentUpdated(content);
            } else {
                console.log('üìù Nenhum conte√∫do encontrado');
                this.showFeedback('Nenhum conte√∫do salvo', 'info');
            }

        } catch (error) {
            console.error('‚ùå Erro no carregamento:', error);
            this.showFeedback('Erro no carregamento', 'error');
        } finally {
            // Remove loading sempre
            if (willTrySupabase) {
                this.hideSupabaseLoading();
            }
        }
    }

    /**
     * DEPRECATED: Mantido para compatibilidade, mas usa smartLoad
     */
    async executeLoad() {
        return this.smartLoad('manual');
    }

    /**
     * CARREGA DO CACHE LOCAL
     */
    loadFromLocalCache() {
        try {
            const chaveCache = `richtext_cache_${this.currentSemana}`;
            const dadosString = localStorage.getItem(chaveCache);
            
            if (dadosString) {
                const dados = JSON.parse(dadosString);
                return dados.conteudo || null;
            }
            
            return null;
        } catch (error) {
            console.error('Erro ao carregar do cache local:', error);
            return null;
        }
    }

    /**
     * APLICA CONTE√öDO NO EDITOR
     */
    applyContentToEditor(content) {
        const editor = document.getElementById('text-editor');
        if (!editor) {
            console.log('‚ö†Ô∏è Editor n√£o encontrado - salvando para aplicar depois');
            this.pendingContent = content;
            return;
        }

        try {
            editor.innerHTML = content;
            
            // Atualiza classe empty
            if (content.trim() === '') {
                editor.classList.add('is-empty');
            } else {
                editor.classList.remove('is-empty');
            }
            
            // Atualiza estat√≠sticas se dispon√≠vel
            if (window.editor && typeof window.editor.updateStats === 'function') {
                window.editor.updateStats();
                window.editor.updatePlaceholder();
            }
            
            console.log('‚úÖ Conte√∫do aplicado no editor');
            
        } catch (error) {
            console.error('‚ùå Erro ao aplicar conte√∫do:', error);
        }
    }

    /**
     * SINALIZA MUDAN√áAS PARA OUTRAS P√ÅGINAS
     */
    signalContentUpdated(content) {
        const signal = {
            content: content,
            semana: this.currentSemana,
            timestamp: Date.now()
        };

        // Para outras abas
        localStorage.setItem('sync_signal_content_updated', JSON.stringify(signal));
        
        // Remove o sinal para permitir novo trigger
        setTimeout(() => {
            localStorage.removeItem('sync_signal_content_updated');
        }, 100);

        // Para mesma aba
        document.dispatchEvent(new CustomEvent('syncbridge_content_updated', {
            detail: signal
        }));
    }

    /**
     * SOLICITA CARREGAMENTO EM TODAS AS P√ÅGINAS - FOR√áADO
     */
    requestLoadInAllPages() {
        // Primeiro limpa a flag para for√ßar carregamento do Supabase
        this.clearLoadedFlag();
        
        const signal = {
            semana: this.currentSemana,
            timestamp: Date.now(),
            forced: true // Marca como for√ßado
        };

        // Para outras abas
        localStorage.setItem('sync_signal_load_content', JSON.stringify(signal));
        
        // Remove o sinal
        setTimeout(() => {
            localStorage.removeItem('sync_signal_load_content');
        }, 100);

        // Para mesma aba
        document.dispatchEvent(new CustomEvent('syncbridge_load_request', {
            detail: signal
        }));

        console.log('üì° Carregamento FOR√áADO enviado para todas as p√°ginas');
    }

    /**
     * FEEDBACK VISUAL
     */
    showFeedback(message, type) {
        const statusDiv = document.getElementById('save-status');
        if (statusDiv) {
            statusDiv.textContent = message;
            statusDiv.className = `save-status show ${type}`;
            
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 3000);
        }
        
        console.log(`üì± Feedback: ${message} (${type})`);
    }

    /**
     * NOVO: Controles do loading overlay do Supabase
     */
    showSupabaseLoading() {
        const loadingOverlay = document.getElementById('supabase-loading');
        if (loadingOverlay) {
            loadingOverlay.classList.add('show');
            console.log('‚è≥ Loading Supabase mostrado');
        }
    }

    hideSupabaseLoading() {
        const loadingOverlay = document.getElementById('supabase-loading');
        if (loadingOverlay) {
            // Pequeno delay para evitar flash muito r√°pido
            setTimeout(() => {
                loadingOverlay.classList.remove('show');
                console.log('‚úÖ Loading Supabase escondido');
            }, 300);
        }
    }

    // === M√âTODOS P√öBLICOS === //

    forceLoad() {
        console.log('üîÑ Carregamento for√ßado iniciado');
        this.clearLoadedFlag(); // Limpa flag para for√ßar Supabase
        this.smartLoad('manual');
    }

    forceLoadAllPages() {
        console.log('üîÑ Carregamento for√ßado em TODAS as p√°ginas');
        this.requestLoadInAllPages();
    }

    getStatus() {
        return {
            semana: this.currentSemana,
            logado: this.isLoggedIn,
            jaCarregou: this.hasLoadedFromSupabase,
            pagina: this.detectPage(),
            temEditor: !!document.getElementById('text-editor')
        };
    }

    debug() {
        console.log('=== DEBUG SYNC BRIDGE ===');
        console.log('Status:', this.getStatus());
        console.log('SupabaseSync:', !!window.SupabaseSync);
        
        const loadKey = `supabase_loaded_${this.currentSemana}`;
        console.log('Flag de carregamento:', localStorage.getItem(loadKey));
        
        const editor = document.getElementById('text-editor');
        if (editor) {
            console.log('Conte√∫do do editor:', editor.innerHTML.substring(0, 100) + '...');
        }
    }
}

// Inst√¢ncia global
if (!window.SyncBridge) {
    window.SyncBridge = new SyncBridge();
}

// M√©todos p√∫blicos
window.forceLoad = () => window.SyncBridge.forceLoad();
window.forceLoadAllPages = () => window.SyncBridge.forceLoadAllPages();
window.syncBridgeStatus = () => window.SyncBridge.getStatus();
window.debugSyncBridge = () => window.SyncBridge.debug();
window.clearLoadFlag = () => window.SyncBridge.clearLoadedFlag(); // NOVO: para debug

console.log('üåâ SyncBridge carregado!');
console.log('üõ†Ô∏è Comandos: window.forceLoad(), window.forceLoadAllPages(), window.debugSyncBridge()');
console.log('üõ†Ô∏è Debug: window.clearLoadFlag() - limpa flag de carregamento');