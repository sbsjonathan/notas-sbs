// negrita.js - Plugin de Negrito e It√°lico robusto (iPhone-first)

class BoldItalicPlugin {
  constructor() {
    this.name = 'bold-italic';
    this.slotId = 2; // slot 2 na barra

    this.editor = null;
    this.boldBtn = null;
    this.italicBtn = null;

    this._retryMs = 100;
    this._selectionCheckInterval = null;

    this.autoRegister();
  }

  // === Boot ===
  autoRegister() {
    const waitForToolbarObj = () => {
      if (window.toolbar) {
        this.waitForSlotAndRegister();
      } else {
        setTimeout(waitForToolbarObj, this._retryMs);
      }
    };
    waitForToolbarObj();
  }

  waitForSlotAndRegister() {
    const slotEl = document.getElementById(`plugin-slot-${this.slotId}`);
    if (slotEl) {
      this._attemptRegister();
    } else {
      // Slots ainda n√£o criados pela barra -> tenta de novo
      setTimeout(() => this.waitForSlotAndRegister(), this._retryMs);
    }
  }

  _attemptRegister() {
    const pluginHTML = `
      <div class="bold-italic-plugin">
        <button class="format-btn bold-btn" id="bold-btn" title="Negrito" aria-label="Negrito">
          <svg class="format-icon" viewBox="0 0 24 24">
            <path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"/>
          </svg>
        </button>
        <button class="format-btn italic-btn" id="italic-btn" title="It√°lico" aria-label="It√°lico">
          <svg class="format-icon" viewBox="0 0 24 24">
            <path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"/>
          </svg>
        </button>
      </div>
    `;

    const ok = window.toolbar.registerPlugin(this.name, this.slotId, this, pluginHTML);
    if (!ok) {
      // Slot indispon√≠vel -> re-tenta
      setTimeout(() => this._attemptRegister(), this._retryMs);
      return;
    }

    this.boldBtn = document.getElementById('bold-btn');
    this.italicBtn = document.getElementById('italic-btn');

    // Eventos de clique
    this.boldBtn.addEventListener('click', (e) => {
      e.preventDefault();
      this.toggleBold();
    });

    this.italicBtn.addEventListener('click', (e) => {
      e.preventDefault();
      this.toggleItalic();
    });

    // Atalhos de teclado (Cmd/Ctrl + B e I)
    document.addEventListener('keydown', (e) => {
      if (e.metaKey || e.ctrlKey) {
        const k = e.key.toLowerCase();
        if (k === 'b') {
          e.preventDefault();
          this.toggleBold();
        } else if (k === 'i') {
          e.preventDefault();
          this.toggleItalic();
        }
      }
    });

    // Agora conecta no editor
    this.waitForEditor();
  }

  waitForEditor() {
    const check = () => {
      if (window.editor && window.editor.editorElement) {
        this.connectToEditor();
      } else {
        setTimeout(check, this._retryMs);
      }
    };
    check();
  }

  connectToEditor() {
    this.editor = window.editor;
    const el = this.editor.editorElement;

    // Monitora mudan√ßas de sele√ß√£o para atualizar estado dos bot√µes
    document.addEventListener('selectionchange', () => {
      this.updateButtonStates();
    });

    // Tamb√©m atualiza ao focar/desfocar
    el.addEventListener('focus', () => {
      this.updateButtonStates();
    });

    el.addEventListener('blur', () => {
      // Pequeno delay para n√£o perder estado ao clicar nos bot√µes
      setTimeout(() => this.updateButtonStates(), 100);
    });

    // Atualiza ap√≥s mudan√ßas no conte√∫do
    el.addEventListener('input', () => {
      this.updateButtonStates();
    });

    // Estado inicial
    this.updateButtonStates();
    
    console.log('üîó Negrito/It√°lico conectado');
  }

  // === A√ß√µes de formata√ß√£o ===
  toggleBold() {
    if (!this.editor || !this.editor.editorElement) return;
    
    // Garante que o editor tem foco
    this.editor.editorElement.focus();
    
    // Aplica/remove negrito
    document.execCommand('bold', false, null);
    
    // Atualiza estados
    this.updateButtonStates();
    
    // Mant√©m o foco no editor
    this.editor.editorElement.focus();
  }

  toggleItalic() {
    if (!this.editor || !this.editor.editorElement) return;
    
    // Garante que o editor tem foco
    this.editor.editorElement.focus();
    
    // Aplica/remove it√°lico
    document.execCommand('italic', false, null);
    
    // Atualiza estados
    this.updateButtonStates();
    
    // Mant√©m o foco no editor
    this.editor.editorElement.focus();
  }

  // === Detec√ß√£o de estado ===
  updateButtonStates() {
    if (!this.boldBtn || !this.italicBtn) return;

    // Verifica se o editor est√° focado ou se h√° sele√ß√£o
    const selection = window.getSelection();
    const hasSelection = selection && !selection.isCollapsed;
    const editorHasFocus = this.editor && 
                          this.editor.editorElement && 
                          this.editor.editorElement === document.activeElement;

    // S√≥ verifica formata√ß√£o se editor focado ou h√° sele√ß√£o
    if (editorHasFocus || hasSelection) {
      // Verifica estado atual da formata√ß√£o
      const isBold = this.queryCommandState('bold');
      const isItalic = this.queryCommandState('italic');

      // Atualiza classes dos bot√µes
      this.boldBtn.classList.toggle('active', isBold);
      this.italicBtn.classList.toggle('active', isItalic);

      // Atualiza aria-pressed para acessibilidade
      this.boldBtn.setAttribute('aria-pressed', isBold);
      this.italicBtn.setAttribute('aria-pressed', isItalic);
    } else {
      // Remove estado ativo quando editor n√£o est√° focado
      this.boldBtn.classList.remove('active');
      this.italicBtn.classList.remove('active');
      this.boldBtn.setAttribute('aria-pressed', 'false');
      this.italicBtn.setAttribute('aria-pressed', 'false');
    }
  }

  queryCommandState(command) {
    try {
      // Verifica se o comando est√° ativo na posi√ß√£o atual
      return document.queryCommandState(command);
    } catch (e) {
      return false;
    }
  }

  // === Utilit√°rios ===
  getSelectedText() {
    const selection = window.getSelection();
    if (selection && selection.rangeCount > 0) {
      return selection.toString();
    }
    return '';
  }

  hasSelection() {
    const selection = window.getSelection();
    return selection && !selection.isCollapsed && selection.toString().length > 0;
  }

  destroy() {
    // Limpa interval se existir
    if (this._selectionCheckInterval) {
      clearInterval(this._selectionCheckInterval);
    }
    
    // Remove listeners se necess√°rio
    console.log('üóëÔ∏è Plugin Negrito/It√°lico destru√≠do');
  }
}

// Auto-start
const boldItalicPlugin = new BoldItalicPlugin();