<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>TXT2 — Identificador de linhas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
/* Base */
html, body { height: 100%; margin: 0; padding: 0; font-family: system-ui, -apple-system, Arial, sans-serif; background: #f5f7fa; }
body { max-width: 100vw; padding: 0 3vw 6vw; box-sizing: border-box; }
h2 { margin: 16px 0 10px; font-size: 1rem; font-weight: 600; color: #2b3a55; }

/* Abas */
.tabs { position: sticky; top: 0; z-index: 5; display: flex; gap: 8px; padding: 10px 0; background: #f5f7fa; }
.tabs a { flex: 1; text-align: center; text-decoration: none; font-size: .9em; padding: .55em .7em; border-radius: 8px; background: #fff; color: #2b3a55; border: 1px solid #d6dae3; box-shadow: 0 1px 2.5px #0001; }
.tabs a.active { background: #3264b2; color: #fff; border-color: #3264b2; }

/* Ações e Botões */
.actions { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
.btn { font-size: .88em; padding: .55em .95em; border-radius: 9px; border: 1px solid transparent; box-shadow: 0 1px 2.5px #0001; min-height: 36px; cursor: pointer; transition: transform .06s, background .12s, border-color .12s; }
.btn:active { transform: translateY(1px); }
.btn-primary { background: #3264b2; color: #fff; }
.btn-secondary { background: #eef3ff; color: #274f8e; border-color: #c9d7fb; }
.btn-success { background: #23b94d; color: #fff; }

/* Áreas de texto */
textarea {
  width: 100%; font-size: 0.86em; border-radius: 9px; box-sizing: border-box;
  border: 1px solid #b8bac7; background: #fff; resize: vertical;
  margin: 8px 0 12px; line-height: 1.32; transition: border .13s;
  font-family: inherit; padding: 1em;
}
textarea:focus { border-color: #3264b2; outline: none; }
#inputArea { min-height: 140px; max-height: 40vh; }
#outputArea { min-height: 520px; max-height: 80vh; }

@media (min-width: 900px) {
  body { max-width: 520px; margin: 32px auto; }
  .tabs a { flex: unset; }
  textarea { font-size: 0.92em; }
}
  </style>
</head>
<body>
<nav class="tabs">
  <a href="txt1.html">TXT1</a>
  <a href="txt2.html" class="active">TXT2</a>
  <a href="txt3.html">TXT3</a>
  <a href="txt4.html">TXT4</a>
</nav>

  <h2>Identificar linhas (estudo / tema / etc.)</h2>

  <textarea id="inputArea" placeholder="Cole aqui o texto para identificar as linhas."></textarea>

  <div class="actions">
    <button class="btn btn-primary" onclick="processar()">Processar</button>
    <button id="copyBtn" class="btn btn-secondary" onclick="copiarResultado()">Copiar</button>
    <span style="flex: 1 1 auto;"></span>
    <button id="sendTXT3Btn" class="btn btn-primary" onclick="enviarParaTXT3()">Enviar para TXT3</button>
  </div>

  <textarea id="outputArea" readonly placeholder="O texto marcado aparecerá aqui..."></textarea>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const semente = localStorage.getItem('TXT2_SEMENTE');
        if (semente) {
          document.getElementById('inputArea').value = semente;
          localStorage.removeItem('TXT2_SEMENTE');
        }
      } catch (e) {}
    });

    function processar() {
      const bruto = document.getElementById('inputArea').value.replace(/\r\n?/g, '\n');
      // CÓDIGO NOVO - USE ESTE
// CÓDIGO NOVO E INTELIGENTE
const textoComRecap = bruto.replace(
  /\[Quadro\]([\s\S]*?)\[Fim do quadro\.?\]/gi,
  (_m, conteudo) => {
    // Define quais caracteres contam como um "bullet point"
    // Usamos '•' (bullet) e '-' (hífen)
    const temBulletPoint = /•/.test(conteudo);

    if (temBulletPoint) {
      // Se encontrou pelo menos um bullet, cria a tag <recap>
      return `<recap>${(conteudo || '').trim()}</recap>`;
    } else {
      // Se não encontrou nenhum, retorna uma string vazia,
      // deletando efetivamente o bloco [Quadro]...[Fim do quadro]
      return '';
    }
  }
);
      const linhas = textoComRecap.split('\n');

      let estudoFeito = false, temaFeito = false, citacaoFeita = false;
      let jaViuPergunta = false, inRecap = false;
      
      let primeiroCantico = null;
      let primeiroCanticoMovido = false;
      
      const saida = [];
      const iniciaComEspecial = /^[<\*\#\+\-\u2013\u2014\u2022\u00B7>\[\]\{\}\(\)\/\\\|\~\^\=\:\;\,\.\!\?]/;

      for (let i = 0; i < linhas.length; i++) {
        const original = linhas[i];
        const txt = original.trim();

        if (txt.includes('<recap>')) inRecap = true;
        if (txt === '') {
          saida.push(original);
          if (txt.includes('</recap>')) inRecap = false;
          continue;
        }
        if (inRecap) {
          saida.push(original);
          if (txt.includes('</recap>')) inRecap = false;
          continue;
        }
        if (/^objetivo$/i.test(txt)) {
          let j = i + 1;
          while (j < linhas.length && linhas[j].trim() === '') j++;
          if (j < linhas.length) {
            saida.push(`<objetivo>Objetivo\n${linhas[j].trimEnd()}</objetivo>`);
            i = j;
          } else {
            saida.push(`<objetivo>${txt}</objetivo>`);
          }
          continue;
        }
        if (!estudoFeito && /^estudo\b/i.test(txt)) {
          saida.push(`<estudo>${txt.replace(/,\s*$/, '')}</estudo>`);
          estudoFeito = true;
          continue;
        }
        
        if (/^c[âa]ntico\b/i.test(txt)) {
          if (!primeiroCanticoMovido) {
            primeiroCantico = `<cantico>${txt}</cantico>`;
            primeiroCanticoMovido = true;
            continue;
          }
          saida.push(`<cantico>${txt}</cantico>`);
          continue;
        }
        
        if (estudoFeito && !temaFeito && /\(.*\)\s*$/.test(txt)) {
          saida.push(`<tema>${txt.replace(/\s*\([^()]*\)\s*$/, '')}</tema>`);
          temaFeito = true;
          continue;
        }
        if (estudoFeito && temaFeito && !citacaoFeita && /^["“].*["”]\s*(?:—|-\s)\s*.+/.test(txt)) {
          saida.push(`<citacao>${txt}</citacao>`);
          citacaoFeita = true;
          continue;
        }
        
        // ===== NOVO: Tratar Notas de Rodapé =====
        // Procura por linhas que começam com *, # ou + seguido de espaço
        if (/^[*#+]\s/.test(txt)) {
          saida.push(`<rodape>${txt}</rodape>`);
          continue;
        }

        if (/^\d+(?:-\d+)?\.\s+.+/.test(txt)) {
          saida.push(`<pergunta>${txt}</pergunta>`);
          jaViuPergunta = true;
          continue;
        }
        if (jaViuPergunta && /^\d+\s+.+/.test(txt)) {
          saida.push(`<paragrafo>${txt}</paragrafo>`);
          continue;
        }
        if (!iniciaComEspecial.test(txt)) {
          saida.push(`<subtitulo>${txt}</subtitulo>`);
          continue;
        }
        saida.push(original);
      }

      if (primeiroCantico) {
        const idxEstudo = saida.findIndex(l => l.trim().startsWith('<estudo>'));
        if (idxEstudo >= 0) {
          saida.splice(idxEstudo + 1, 0, primeiroCantico);
        } else {
          saida.unshift(primeiroCantico);
        }
      }

      document.getElementById('outputArea').value = saida.join('\n');
      const copyBtn = document.getElementById('copyBtn');
      copyBtn.classList.remove('btn-success');
      copyBtn.innerText = 'Copiar';
    }

    function copiarResultado() {
      const output = document.getElementById('outputArea');
      if (!output.value.trim()) return;
      output.select();
      document.execCommand('copy');
      const btn = document.getElementById('copyBtn');
      btn.classList.add('btn-success');
      btn.innerText = 'Copiado!';
      setTimeout(() => {
        btn.classList.remove('btn-success');
        btn.innerText = 'Copiar';
      }, 1200);
    }

    function enviarParaTXT3() {
      const conteudo = document.getElementById('outputArea').value;
      if (conteudo.trim()) {
        localStorage.setItem('TXT3_SEMENTE', conteudo);
        window.location.href = 'txt3.html';
      } else {
        alert('Nada a enviar. Processe um texto primeiro.');
      }
    }
  </script>
</body>
</html>