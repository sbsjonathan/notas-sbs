<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Bíblia</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;700;800&family=Sumana:wght@400;700&display=swap" rel="stylesheet">

  <!-- Swiper -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <!-- Navbar -->
  <link rel="stylesheet" href="../navbar/navbar-unified.css"/>

  <style>
    :root{
      --primary-color:#5B3C88;
      --accent-blue:#2d6bb3;
      --header-bg:#e4e3e8;
      --body-bg:#f0f2f5;
    }
    body{
      font-family: 'Noto Sans', sans-serif;
      background-color:var(--body-bg);
      margin:0; padding:0;
      overscroll-behavior-x:none;
      -webkit-text-size-adjust:100%;
      text-size-adjust:100%;
    }
    .header{
      position:fixed; top:0; left:0; right:0; z-index:20;
      display:flex; justify-content:center; align-items:center;
      padding:10px 15px; background-color:var(--header-bg);
      border-bottom:1px solid #dcdcdc; box-sizing:border-box;
      height:52px;
      /* POLIMENTO: Transição suave para o movimento */
      transition:transform .22s ease-in-out;
      will-change:transform;
    }
    .header .back-button{
      position:absolute; left:15px; color:var(--primary-color);
      text-decoration:none; font-size:1.1em; font-weight:500;
    }
    .header .title{ font-size:.95em; font-weight:700; }
    .swiper{ width:100%; height:100vh; }
    .swiper-slide{
      box-sizing:border-box;
      padding:60px 30px calc(88px + env(safe-area-inset-bottom)) 30px;
      overflow-y:auto;
      -webkit-user-select:text; user-select:text;
      -webkit-touch-callout:default;
      /* POLIMENTO: Transição suave para o padding, sincronizada com as barras */
      transition:padding-top .22s ease-in-out;
      will-change:padding-top;
    }
    .book-title{
      font-family: 'Noto Sans', sans-serif;
      font-size:1.5em; font-weight:800;
      margin-top:0; margin-bottom:10px; color:#333;
    }
    .chapter-start{ position: relative; }
    .chapter-number-large{
      position: absolute; left: 0; top: 0;
      font-family: 'Noto Sans', sans-serif;
      font-size: 2rem;
      font-weight: 800;
      color: var(--accent-blue);
      line-height: 1;
      transform: translateY(-0.2em);
      user-select:none;
      pointer-events:none;
    }
    .verse-block{
      font-family: 'Sumana', serif;
      line-height: 1.6;
      font-size:1.1em;
      text-align:justify;
      text-indent:0;
    }
    .verse-block.paragraph-indented{ margin-top: 0.25em; }
    .verse-block .verse-number:first-child { margin-left: 1.6em; }
    .verse-block.paragraph-indented .verse-number:first-child { margin-left: 1.5em; }
    .chapter-start .verse-block { text-indent: 1.6em; }
    .chapter-start.two-digits .verse-block { text-indent: 2.5em; }
    .chapter-start.three-digits .verse-block { text-indent: 3.4em; }
    .verse-number{
      font-family: 'Noto Sans', sans-serif;
      display:inline-block;
      font-size:1em; font-weight:700;
      color:var(--accent-blue);
      line-height:1; vertical-align:middle;
      margin-right:.5em; transform:translateY(-0.15em);
    }
    .bottom-navbar{
      transition:transform .22s ease-in-out;
      will-change:transform;
    }

    /* POLIMENTO: Lógica de ocultar/mostrar agora é controlada por uma única classe no body */
    body.bars-hidden .header{ transform:translateY(-110%); }
    body.bars-hidden .bottom-navbar{ transform:translateY(110%); }
    body.bars-hidden .swiper-slide{ padding-top: 8px; /* Mantém um respiro mínimo no topo */ }
  </style>
</head>
<body>

  <div class="header">
    <a id="back-to-chapters-link" href="#" class="back-button">< Voltar</a>
    <span id="header-title" class="title"></span>
  </div>

  <div class="swiper">
    <div class="swiper-wrapper" id="bible-content-wrapper"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    /* ==================== UTIL / ESTADO ==================== */
    const headerEl      = document.querySelector('.header');
    const headerTitle   = document.getElementById('header-title');
    const contentWrapper= document.getElementById('bible-content-wrapper');
    const backLink      = document.getElementById('back-to-chapters-link');

    const LS_LAST_KEY   = 'bbl:lastPage';
    const LS_SCROLL_NS  = 'bbl:pos:capitulo:';
    const EXPIRATION_TIME_MS = 30 * 60 * 1000;

    function normalizeBookParam(x){
      if (!x) return '';
      let s = (''+x).toLowerCase().trim();
      s = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      s = s.replace(/\s+/g,'');
      return s;
    }

    function saveLast(bookKey, cap, scrollTop){
      try{
        localStorage.setItem(LS_LAST_KEY, JSON.stringify({
          page: 'capitulo', href: location.href, book: bookKey,
          cap: Number(cap) || 1, scrollTop: Number(scrollTop) || 0,
          t: Date.now(), schema: 1
        }));
        localStorage.setItem(LS_SCROLL_NS + bookKey + ':' + cap, String(Math.max(0, scrollTop|0)));
      }catch(e){}
    }

    function readSavedScroll(bookKey, cap){
      try {
        const lastRaw = localStorage.getItem(LS_LAST_KEY);
        if (lastRaw) {
          const last = JSON.parse(lastRaw);
          const isRecent = last && last.t && (Date.now() - last.t < EXPIRATION_TIME_MS);
          if (!isRecent) return 0;
        }
      } catch(e) { return 0; }
      const v = localStorage.getItem(LS_SCROLL_NS + bookKey + ':' + cap);
      return v ? (parseInt(v,10)||0) : 0;
    }

    /* ==================== SHOW/HIDE BARRAS ==================== */
    /* OTIMIZAÇÃO: Funções agora são extremamente simples e eficientes */
    function showBars(){
      document.body.classList.remove('bars-hidden');
    }
    function hideBars(){
      document.body.classList.add('bars-hidden');
    }

    function wireScroll(slideEl, bookKey, cap){
      if (!slideEl || slideEl.__wired) return;
      slideEl.__wired = true;

      let lastY = slideEl.scrollTop;
      let saveTimer = null;

      slideEl.addEventListener('scroll', ()=>{
        const y  = slideEl.scrollTop;
        const dy = y - lastY;
        const scrollHeight = slideEl.scrollHeight;
        const clientHeight = slideEl.clientHeight;
        const isAtBottom = (y + clientHeight) >= (scrollHeight - 5);

        if (isAtBottom || y <= 10) { showBars(); }
        else if (dy > 0 && y > 80) { hideBars(); }
        else if (dy < 0) { showBars(); }

        clearTimeout(saveTimer);
        saveTimer = setTimeout(()=> saveLast(bookKey, cap, y), 250);

        lastY = y < 0 ? 0 : y;
      }, {passive:true});
    }

    /* ===== Fallback inteligente p/ diferentes pastas/nomes ===== */
    const bookFolderMap = {
      'genesis':'01-genesis','exodo':'02-exodo','levitico':'03-levitico','numeros':'04-numeros','deuteronomio':'05-deuteronomio',
      'josue':'06-josue','juizes':'07-juizes','rute':'08-rute','1samuel':'09-1samuel','2samuel':'10-2samuel',
      '1reis':'11-1reis','2reis':'12-2reis','1cronicas':'13-1cronicas','2cronicas':'14-2cronicas','esdras':'15-esdras',
      'neemias':'16-neemias','ester':'17-ester','jo':'18-jo','salmos':'19-salmos','proverbios':'20-proverbios',
      'eclesiastes':'21-eclesiastes','canticos':'22-canticos','isaias':'23-isaias','jeremias':'24-jeremias',
      'lamentacoes':'25-lamentacoes','ezequiel':'26-ezequiel','daniel':'27-daniel','oseias':'28-oseias','joel':'29-joel',
      'amos':'30-amos','obadias':'31-obadias','jonas':'32-jonas','miqueias':'33-miqueias','naum':'34-naum',
      'habacuque':'35-habacuque','sofonias':'36-sofonias','ageu':'37-ageu','zacarias':'38-zacarias','malaquias':'39-malaquias',
      'mateus':'40-mateus','marcos':'41-marcos','lucas':'42-lucas','joao':'43-joao','atos':'44-atos','romanos':'45-romanos',
      '1corintios':'46-1corintios','2corintios':'47-2corintios','galatas':'48-galatas','efesios':'49-efesios',
      'filipenses':'50-filipenses','colossenses':'51-colossenses','1tessalonicenses':'52-1tessalonicenses',
      '2tessalonicenses':'53-2tessalonicenses','1timoteo':'54-1timoteo','2timoteo':'55-2timoteo','tito':'56-tito',
      'filemom':'57-filemom','hebreus':'58-hebreus','tiago':'59-tiago','1pedro':'60-1pedro','2pedro':'61-2pedro',
      '1joao':'62-1joao','2joao':'63-2joao','3joao':'64-3joao','judas':'65-judas','apocalipse':'66-apocalipse'
    };

    async function fetchBookData(bookParam){
      const raw      = normalizeBookParam(bookParam);
      const noPrefix = raw.replace(/^\d{1,2}-/,'');
      const mapped   = bookFolderMap[noPrefix] || noPrefix;
      const candidates = [ `livro/${mapped}/${noPrefix}.json`, `livro/${noPrefix}/${noPrefix}.json`, `${noPrefix}.json` ];
      for (const url of candidates){
        try{
          const r = await fetch(url);
          if (r.ok){
            const data = await r.json();
            return { data, basePath: url.slice(0, url.lastIndexOf('/')+1), bookKey:noPrefix };
          }
        }catch(e){}
      }
      throw new Error('Não foi possível carregar os dados do livro.');
    }

    function renderChapterContent(chapterData, bookName){
      let finalHtml = '';
      if (String(chapterData.capitulo) === '1'){
        finalHtml += `<div class="book-title">${(bookName||'').toUpperCase()}</div>`;
      }
      const chapterNum = chapterData.capitulo;
      let chapterStartClass = 'chapter-start';
      if (chapterNum >= 100) { chapterStartClass += ' three-digits'; }
      else if (chapterNum >= 10) { chapterStartClass += ' two-digits'; }

      const firstVerse = (chapterData.versiculos && chapterData.versiculos[0]) || {};
      finalHtml += `
        <div class="${chapterStartClass}">
          <span class="chapter-number-large">${chapterNum}</span>
          <div class="verse-block">${firstVerse.texto || ''}</div>
        </div>`;
      const other = (chapterData.versiculos || []).slice(1);
      let block = '';
      let firstPara = true;
      other.forEach(v=>{
        if (v && v.novo_paragrafo && block){
          finalHtml += `<div class="${firstPara?'verse-block':'verse-block paragraph-indented'}">${block}</div>`;
          block=''; firstPara=false;
        }
        if (!v) return;
        const span = `<span class="verse-number">${v.verso}</span>${v.texto || ''}`;
        block += (block?' ':'') + span;
      });
      if (block){
        finalHtml += `<div class="${firstPara?'verse-block':'verse-block paragraph-indented'}">${block}</div>`;
      }
      return finalHtml;
    }

    async function loadBook(){
      try{
        const qs = new URLSearchParams(location.search);
        const rawBookParam   = qs.get('livro');
        const capFromUrl     = parseInt(qs.get('cap') || '0', 10) || 0;
        if (!rawBookParam) throw new Error('Use ?livro=NOME&cap=X');

        const { data:bibleBook, basePath, bookKey } = await fetchBookData(rawBookParam);
        
        // OTIMIZAÇÃO: A variável `last` foi removida daqui pois `readSavedScroll` já
        // contém a lógica de expiração, e a URL tem prioridade.
        const initialChapter = capFromUrl || 1;

        backLink.addEventListener('click', (ev)=>{
          ev.preventDefault();
          location.href = `${basePath}${bookKey}.html`;
        });

        (bibleBook.capitulos || []).forEach(chapter=>{
          const slide = document.createElement('div');
          slide.className = 'swiper-slide';
          slide.setAttribute('data-chapter-number', chapter.capitulo);
          slide.innerHTML = renderChapterContent(chapter, bibleBook.nome_do_livro);
          contentWrapper.appendChild(slide);
        });

        new Swiper('.swiper', {
          initialSlide: Math.max(0, initialChapter - 1),
          touchStartPreventDefault: false,
          noSwipingSelector: '.verse-block',
          threshold: 20,
          longSwipesRatio: 0.1,
          longSwipesMs: 200,
          on: {
            slideChange(){
              const slide = this.slides[this.activeIndex];
              const newCap = slide.getAttribute('data-chapter-number');
              headerTitle.textContent = `${bibleBook.nome_do_livro} ${newCap}`;
              try{
                const path = location.pathname;
                const dir  = path.substring(0, path.lastIndexOf('/')+1);
                const newUrl = `${dir}capitulo.html?livro=${encodeURIComponent(normalizeBookParam(rawBookParam))}&cap=${encodeURIComponent(newCap)}`;
                history.pushState({}, '', newUrl);
              }catch(e){}
              const savedY = readSavedScroll(bookKey, newCap);
              slide.scrollTop = savedY;
              wireScroll(slide, bookKey, newCap);
              showBars();
              saveLast(bookKey, newCap, slide.scrollTop);
            },
            // OTIMIZAÇÃO: Lógica de 'init' e 'slideChange' combinada em uma função
            // para evitar repetição de código.
            afterInit(swiper) {
                swiper.emit('slideChange'); // Dispara slideChange na inicialização
            }
          }
        });

        const persistNow = ()=>{
          const active = document.querySelector('.swiper-slide.swiper-slide-active');
          if (!active) return;
          const cap = active.getAttribute('data-chapter-number') || 1;
          saveLast(bookKey, cap, active.scrollTop || 0);
        };
        window.addEventListener('pagehide', persistNow);
        document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='hidden') persistNow(); });

      }catch(err){
        console.error('Erro fatal:', err);
        contentWrapper.innerHTML = `<div class="swiper-slide" style="padding:80px 30px;">
          <h2>Erro</h2><p>${err.message}</p></div>`;
      }
    }
    window.getBasePath = function(){ return '../'; };
    loadBook();
  </script>
  <script src="../navbar/navbar-unified.js"></script>
</body>
</html>