<!DOCTYPE html>

<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Load Supabase</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f7;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #3F3C6D;
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }
        .test-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        .result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #output {
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug do Sistema de Load</h1>

```
    <div class="test-section">
        <div class="test-title">üìä Status do Sistema</div>
        <div id="status-output" class="result info">Verificando...</div>
    </div>

    <div class="test-section">
        <div class="test-title">üîß Configura√ß√µes</div>
        <div class="input-group">
            <label for="semana-input">Semana para testar:</label>
            <input type="text" id="semana-input" placeholder="Ex: 09-01" value="">
        </div>
    </div>

    <div class="test-section">
        <div class="test-title">üß™ Testes Dispon√≠veis</div>
        <button onclick="testAll()">Executar Todos os Testes</button>
        <button onclick="testSupabaseConnection()">1. Testar Conex√£o Supabase</button>
        <button onclick="testLogin()">2. Verificar Login</button>
        <button onclick="testLoadFromSupabase()">3. Carregar do Supabase</button>
        <button onclick="testLoadFromCache()">4. Carregar do Cache</button>
        <button onclick="testUnifiedLoad()">5. Testar UnifiedLoadManager</button>
        <button onclick="clearAllData()">üóëÔ∏è Limpar Dados Locais</button>
    </div>

    <div class="test-section">
        <div class="test-title">üìù Resultado dos Testes</div>
        <div id="output" class="result info">Aguardando testes...</div>
    </div>
</div>

<!-- Scripts necess√°rios -->
<script src="../save/config.js"></script>
<script src="../save/supabase.js"></script>
<script src="../save/unified-load.js"></script>

<script>
    // Detecta semana atual automaticamente
    function getCurrentWeek() {
        const now = new Date();
        const day = String(now.getDate()).padStart(2, '0');
        const month = String(now.getMonth() + 1).padStart(2, '0');
        return `${day}-${month}`;
    }

    // Preenche input com semana atual
    document.getElementById('semana-input').value = getCurrentWeek();

    // Logger customizado
    function log(message, type = 'info') {
        const output = document.getElementById('output');
        const timestamp = new Date().toLocaleTimeString();
        const colorMap = {
            'success': '‚úÖ',
            'error': '‚ùå',
            'warning': '‚ö†Ô∏è',
            'info': '‚ÑπÔ∏è'
        };
        
        output.innerHTML += `${timestamp} ${colorMap[type]} ${message}\n`;
        output.scrollTop = output.scrollHeight;
        console.log(`${colorMap[type]} ${message}`);
    }

    // Atualiza status
    async function updateStatus() {
        const statusDiv = document.getElementById('status-output');
        let status = '';
        
        // Verifica login
        const user = localStorage.getItem('supabase_user');
        if (user) {
            try {
                const userData = JSON.parse(user);
                status += `‚úÖ Logado como: ${userData.usuario}\n`;
            } catch (e) {
                status += `‚ùå Login corrompido\n`;
            }
        } else {
            status += `‚ùå N√£o logado\n`;
        }
        
        // Verifica Supabase
        if (window.SupabaseSync) {
            status += `‚úÖ SupabaseSync carregado\n`;
            if (window.SupabaseSync.supabase) {
                status += `‚úÖ Cliente Supabase inicializado\n`;
            } else {
                status += `‚ö†Ô∏è Cliente Supabase n√£o inicializado\n`;
            }
        } else {
            status += `‚ùå SupabaseSync n√£o encontrado\n`;
        }
        
        // Verifica UnifiedLoadManager
        if (window.UnifiedLoadManager) {
            const loadStatus = window.UnifiedLoadManager.getStatus();
            status += `‚úÖ UnifiedLoadManager carregado\n`;
            status += `   Semana: ${loadStatus.semana || 'n√£o detectada'}\n`;
            status += `   Editor: ${loadStatus.editor ? 'encontrado' : 'n√£o encontrado'}\n`;
        } else {
            status += `‚ùå UnifiedLoadManager n√£o encontrado\n`;
        }
        
        statusDiv.textContent = status;
    }

    // Testa conex√£o com Supabase
    async function testSupabaseConnection() {
        log('Testando conex√£o com Supabase...', 'info');
        
        if (!window.SupabaseSync) {
            log('SupabaseSync n√£o est√° carregado!', 'error');
            return;
        }
        
        try {
            // Aguarda inicializa√ß√£o
            await window.SupabaseSync.ensureInitialized();
            log('Supabase inicializado com sucesso', 'success');
            
            // Testa uma query simples
            const { data, error } = await window.SupabaseSync.supabase
                .from('usuarios')
                .select('count')
                .limit(1);
            
            if (error) {
                log(`Erro na query de teste: ${error.message}`, 'error');
            } else {
                log('Conex√£o com banco de dados OK', 'success');
            }
        } catch (e) {
            log(`Erro ao conectar: ${e.message}`, 'error');
        }
    }

    // Verifica login
    async function testLogin() {
        log('Verificando status de login...', 'info');
        
        const userStr = localStorage.getItem('supabase_user');
        if (!userStr) {
            log('Nenhum usu√°rio logado no localStorage', 'warning');
            return;
        }
        
        try {
            const user = JSON.parse(userStr);
            log(`Usu√°rio no localStorage: ${user.usuario} (ID: ${user.id})`, 'success');
            
            // Verifica se SupabaseSync reconhece o login
            if (window.SupabaseSync) {
                window.SupabaseSync.checkExistingSession();
                const currentUser = window.SupabaseSync.getCurrentUser();
                
                if (currentUser) {
                    log(`SupabaseSync reconhece usu√°rio: ${currentUser.usuario}`, 'success');
                } else {
                    log('SupabaseSync n√£o reconhece o usu√°rio!', 'error');
                }
            }
        } catch (e) {
            log(`Erro ao verificar login: ${e.message}`, 'error');
        }
    }

    // Testa carregamento do Supabase
    async function testLoadFromSupabase() {
        const semana = document.getElementById('semana-input').value;
        
        if (!semana) {
            log('Por favor, insira uma semana para testar', 'warning');
            return;
        }
        
        log(`Tentando carregar semana ${semana} do Supabase...`, 'info');
        
        if (!window.SupabaseSync) {
            log('SupabaseSync n√£o est√° dispon√≠vel', 'error');
            return;
        }
        
        try {
            // Garante que est√° logado
            window.SupabaseSync.checkExistingSession();
            if (!window.SupabaseSync.currentUser) {
                log('Usu√°rio n√£o est√° logado no SupabaseSync', 'error');
                return;
            }
            
            // Tenta carregar
            const content = await window.SupabaseSync.carregarRichtextAnotacoes(semana);
            
            if (content) {
                log(`Conte√∫do carregado com sucesso! (${content.length} caracteres)`, 'success');
                log(`Preview: ${content.substring(0, 100)}...`, 'info');
            } else {
                log(`Nenhum conte√∫do encontrado para semana ${semana}`, 'warning');
                
                // Vamos verificar diretamente no banco
                const user = window.SupabaseSync.currentUser;
                const { data, error } = await window.SupabaseSync.supabase
                    .from('richtext_anotacoes')
                    .select('*')
                    .eq('usuario_id', user.id)
                    .eq('semana', semana)
                    .eq('tipo', 'richtext');
                
                if (error) {
                    log(`Erro ao consultar banco: ${error.message}`, 'error');
                } else if (data && data.length > 0) {
                    log(`Dados existem no banco mas n√£o foram carregados!`, 'error');
                    log(`Registro encontrado: ${JSON.stringify(data[0])}`, 'info');
                } else {
                    log(`Confirmado: nenhum registro para esta semana`, 'info');
                }
            }
        } catch (e) {
            log(`Erro ao carregar: ${e.message}`, 'error');
            console.error(e);
        }
    }

    // Testa carregamento do cache
    function testLoadFromCache() {
        const semana = document.getElementById('semana-input').value;
        
        if (!semana) {
            log('Por favor, insira uma semana para testar', 'warning');
            return;
        }
        
        log(`Tentando carregar semana ${semana} do cache local...`, 'info');
        
        try {
            // M√©todo 1: via cacheRichText
            if (window.cacheRichText && typeof window.cacheRichText.carregar === 'function') {
                const content = window.cacheRichText.carregar();
                if (content) {
                    log(`Conte√∫do encontrado via cacheRichText (${content.length} caracteres)`, 'success');
                } else {
                    log('Nenhum conte√∫do no cacheRichText', 'warning');
                }
            }
            
            // M√©todo 2: direto do localStorage
            const chaveCache = `richtext_cache_${semana}`;
            const dadosString = localStorage.getItem(chaveCache);
            
            if (dadosString) {
                const dados = JSON.parse(dadosString);
                log(`Conte√∫do encontrado no localStorage (${dados.conteudo.length} caracteres)`, 'success');
                log(`Timestamp: ${new Date(dados.timestamp).toLocaleString()}`, 'info');
            } else {
                log(`Nenhum conte√∫do no localStorage para chave ${chaveCache}`, 'warning');
            }
            
            // Lista todas as chaves de cache
            const cacheKeys = Object.keys(localStorage).filter(k => k.includes('richtext'));
            log(`Chaves de cache encontradas: ${cacheKeys.join(', ') || 'nenhuma'}`, 'info');
            
        } catch (e) {
            log(`Erro ao carregar cache: ${e.message}`, 'error');
        }
    }

    // Testa UnifiedLoadManager
    async function testUnifiedLoad() {
        log('Testando UnifiedLoadManager...', 'info');
        
        if (!window.UnifiedLoadManager) {
            log('UnifiedLoadManager n√£o est√° carregado!', 'error');
            return;
        }
        
        // Mostra status atual
        const status = window.UnifiedLoadManager.getStatus();
        log(`Status: ${JSON.stringify(status, null, 2)}`, 'info');
        
        // For√ßa detec√ß√£o de semana
        const semana = document.getElementById('semana-input').value;
        if (semana) {
            window.UnifiedLoadManager.currentSemana = semana;
            log(`Semana definida para: ${semana}`, 'info');
        }
        
        // Cria um editor fake para teste
        if (!document.getElementById('text-editor')) {
            const fakeEditor = document.createElement('div');
            fakeEditor.id = 'text-editor';
            fakeEditor.style.display = 'none';
            document.body.appendChild(fakeEditor);
            log('Editor fake criado para teste', 'info');
        }
        
        // Executa o load
        log('Executando executeMainLoad()...', 'info');
        await window.UnifiedLoadManager.executeMainLoad();
        
        // Verifica resultado
        const editor = document.getElementById('text-editor');
        if (editor && editor.innerHTML) {
            log(`Conte√∫do carregado no editor! (${editor.innerHTML.length} caracteres)`, 'success');
        } else {
            log('Nenhum conte√∫do foi carregado no editor', 'warning');
        }
    }

    // Executa todos os testes
    async function testAll() {
        log('\n========== INICIANDO BATERIA DE TESTES ==========\n', 'info');
        
        await updateStatus();
        
        log('\n--- Teste 1: Conex√£o Supabase ---', 'info');
        await testSupabaseConnection();
        
        log('\n--- Teste 2: Verifica√ß√£o de Login ---', 'info');
        await testLogin();
        
        log('\n--- Teste 3: Load do Supabase ---', 'info');
        await testLoadFromSupabase();
        
        log('\n--- Teste 4: Load do Cache ---', 'info');
        testLoadFromCache();
        
        log('\n--- Teste 5: UnifiedLoadManager ---', 'info');
        await testUnifiedLoad();
        
        log('\n========== TESTES CONCLU√çDOS ==========\n', 'success');
    }

    // Limpa dados locais
    function clearAllData() {
        if (confirm('Isso vai limpar TODOS os dados locais. Tem certeza?')) {
            // Remove apenas dados relacionados ao richtext
            Object.keys(localStorage).forEach(key => {
                if (key.includes('richtext') || key.includes('supabase_loaded')) {
                    localStorage.removeItem(key);
                    log(`Removido: ${key}`, 'info');
                }
            });
            log('Dados locais limpos!', 'success');
        }
    }

    // Atualiza status ao carregar
    setTimeout(updateStatus, 500);
</script>
```

</body>
</html>